<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Classificador de Emails</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* === Tema escuro === */
    body {
        background-color: white;
        color: #e0e0e0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container { max-width: 1100px; margin-top: 40px; }

    .nav-tabs .nav-link {
        font-weight: 500;
        color: #bbb;
        border-radius: 0.5rem 0.5rem 0 0;
    }
    .nav-tabs .nav-link.active {
        background-color: #0d6efd;
        color: white;
    }

    .card {
        border-radius: 1rem;
        background-color: #1e1e1e;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        color: #e0e0e0;
    }

    .btn-primary {
        border-radius: 0.5rem;
        background-color: #0d6efd;
        border: none;
    }

    .btn-primary:hover {
        background-color: #0b5ed7;
    }

    .btn-secondary {
        background-color: #6c757d;
        border-radius: 0.5rem;
    }

    textarea {
        resize: vertical;
        border-radius: 0.5rem;
        background-color: #2b2b2b;
        color: #e0e0e0;
        border: 1px solid #444;
    }

    .label-badge {
        font-size: 1rem;
        padding: 0.5em 1em;
    }

    pre {
        background-color: #2b2b2b;
        padding: 10px;
        border-radius: 0.5rem;
        overflow-x: auto;
        color: #f8f9fa;
    }

    .history-card {
        background-color: #2a2a2a;
    }

    canvas {
        background-color: #1e1e1e !important;
    }
</style>
</head>
<body>

<div class="container">
    <h1 class="text-center mb-4">Classificador de Emails</h1>

    <!-- NavTabs -->
    <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="send-tab" data-bs-toggle="tab" data-bs-target="#send" type="button">Enviar Mensagem</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button">Dashboard</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">Histórico</button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- === Enviar Mensagem === -->
        <div class="tab-pane fade show active" id="send">
            <div class="card p-4 mb-4">
                <form id="emailForm">
                    <div class="mb-3">
                        <label for="text_input" class="form-label">Digite o conteúdo do email</label>
                        <textarea class="form-control" id="text_input" name="text_input" rows="4" placeholder="Cole o email aqui..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="file_input" class="form-label">Ou envie um arquivo (.txt ou .pdf)</label>
                        <input class="form-control" type="file" id="file_input" name="file_input" accept=".txt,.pdf">
                        <button type="button" class="btn btn-secondary btn-sm mt-2" id="clearFileBtn">Remover arquivo</button>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Enviar</button>
                    <!-- Loader -->
<div id="loader" class="mt-3 text-center" style="display:none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Processando...</span>
    </div>
    <p>O bot está pensando...</p>
</div>

                </form>

                <!-- Resposta dinâmica -->
                <div class="mt-4" id="responseBox" style="display:none;">
                    <h5>Resposta sugerida:</h5>
                    <div class="card p-3 bg-dark border border-secondary">
                        <p id="responseText"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- === Dashboard === -->
        <div class="tab-pane fade" id="dashboard">
            <div class="card p-4 mb-4">
                <h5>Dashboard de Mensagens</h5>
                <canvas id="chartStats" height="50"></canvas>
            </div>
        </div>

        <!-- === Histórico === -->
        <div class="tab-pane fade" id="history">
            <div class="card p-4 mb-4">
                <h5>Histórico de Mensagens</h5>
                <div id="historyContainer">
                    {% if history %}
                        {% for msg in history %}
                        <div class="history-card p-3 mb-3 border rounded">
                            <strong>Categoria:</strong>
                            {% if msg.categoria == "Produtivo" %}
                                <span class="badge bg-success label-badge">{{ msg.categoria }}</span>
                            {% elif msg.categoria == "Improdutivo" %}
                                <span class="badge bg-danger label-badge">{{ msg.categoria }}</span>
                            {% else %}
                                <span class="badge bg-secondary label-badge">{{ msg.categoria }}</span>
                            {% endif %}

                            <div class="mt-2 p-3 bg-dark border rounded border-secondary">
                                <strong>Mensagem para o cliente:</strong>
                                <p>{{ msg.resposta }}</p>
                            </div>

                            <div class="mt-2">
                                <strong>Justificativa:</strong>
                                <p>{{ msg.justificativa }}</p>
                            </div>

                            <div class="mt-2">
                                <strong>Conteúdo do email:</strong>
                                <pre>{{ msg.content }}</pre>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p>Nenhuma mensagem analisada ainda.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const fileInput = document.getElementById('file_input');
const clearBtn = document.getElementById('clearFileBtn');

clearBtn.addEventListener('click', function() {
    fileInput.value = ""; // limpa o arquivo selecionado
});

// Chart.js
const ctx = document.getElementById('chartStats').getContext('2d');
let chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['Produtivas', 'Improdutivas'],
        datasets: [{
            label: 'Mensagens',
            data: [{{ stats.produtivas }}, {{ stats.improdutivas }}],
            backgroundColor: ['#198754','#dc3545'],
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'bottom', labels: { color: '#e0e0e0' } } }
    }
});

// AJAX do formulário
const form = document.getElementById('emailForm');
const responseBox = document.getElementById('responseBox');
const responseText = document.getElementById('responseText');

form.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(form);

    // Mostrar loader e esconder resposta
    responseBox.style.display = "none";
    document.getElementById('loader').style.display = "block";

    fetch("/process", { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
        // Esconder loader e mostrar resposta
        document.getElementById('loader').style.display = "none";
        responseBox.style.display = "block";
        responseText.textContent = data.resposta;

        // Atualiza gráfico
        if(data.categoria === "Produtivo") chart.data.datasets[0].data[0] += 1;
        else if(data.categoria === "Improdutivo") chart.data.datasets[0].data[1] += 1;
        chart.update();

        // Atualiza histórico
        const historyContainer = document.getElementById('historyContainer');
        const newCard = document.createElement('div');
        newCard.className = "history-card p-3 mb-3 border rounded";
        newCard.innerHTML = `
            <strong>Categoria:</strong>
            <span class="badge ${data.categoria === 'Produtivo' ? 'bg-success' : 'bg-danger'} label-badge">${data.categoria}</span>
            <div class="mt-2 p-3 bg-dark border rounded border-secondary">
                <strong>Mensagem para o cliente:</strong>
                <p>${data.resposta}</p>
            </div>
            <div class="mt-2">
                <strong>Justificativa:</strong>
                <p>${data.justificativa}</p>
            </div>
            <div class="mt-2">
                <strong>Conteúdo do email:</strong>
                <pre>${data.content}</pre>
            </div>`;
        historyContainer.prepend(newCard);

        // Limpa formulário
        form.reset();
    })
    .catch(err => {
        document.getElementById('loader').style.display = "none";
        alert("Erro ao processar email: " + err);
    });
});

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
